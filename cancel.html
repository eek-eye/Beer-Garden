<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancel Reservation - Bar Chinesca Mxli</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <a href="index.html" style="text-decoration: none; color: inherit;">
                    <h1>üç∫ Bar Chinesca Mxli</h1>
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Reservations</a></li>
                <li><a href="cancel.html">Cancel</a></li>
                <li><a href="index.html#contact">Contact</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Cancellation Section -->
    <section id="cancellation" class="cancellation">
        <div class="container">
            <h2>Cancel Reservation</h2>
            <p class="section-subtitle">Enter your order number to cancel your reservation</p>
            
            <div class="cancellation-form" id="cancellationForm">
                <!-- Step 1: Order Number -->
                <div class="cancellation-step" id="step1">
                    <div class="form-group">
                        <label for="orderNumber">Order Number *</label>
                        <input type="text" id="orderNumber" name="orderNumber" placeholder="Enter your 6-digit order number" maxlength="6">
                    </div>
                    <button type="button" class="btn btn-primary" id="continueBtn">Continue</button>
                </div>
                
                <!-- Step 2: Select Table -->
                <div class="cancellation-step" id="step2">
                    <div class="form-group">
                        <label for="tableSelect">Select your table *</label>
                        <select id="tableSelect" name="tableSelect">
                            <option value="">Select your table...</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" id="submitCancellationBtn">Cancel Reservation</button>
                </div>
                
                <!-- Thank You Message -->
                <div class="thank-you-message" id="thankYouMessage" style="display: none;">
                    <h2>Thank you for visiting Bar Chinesca</h2>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Bar Chinesca Mxli. All rights reserved.</p>
            <p>Place reservations at <a href="tel:+1234567890">(123) 456-7890</a></p>
        </div>
    </footer>

    <script>
        // Cancellation page JavaScript - runs immediately since script is at end of body
        let currentOrderNumber = null;

        // Step 1: Check order number and populate table dropdown
        document.getElementById('continueBtn').addEventListener('click', function() {
            console.log('Continue button clicked');
            
            const orderNumberInput = document.getElementById('orderNumber');
            if (!orderNumberInput) {
                alert('Order number input not found.');
                return;
            }
            
            let orderNumber = orderNumberInput.value.trim().replace(/\D/g, '');
            console.log('Order number entered:', orderNumber);
            
            if (!orderNumber || orderNumber.length !== 6) {
                alert('Please enter a valid 6-digit order number.');
                return;
            }
            
            // Load order details from localStorage
            const orderDetails = JSON.parse(localStorage.getItem('orderDetails')) || {};
            console.log('Order details loaded:', orderDetails);
            console.log('Looking for order:', orderNumber);
            
            if (!orderDetails[orderNumber]) {
                alert('Unexistent Order number');
                return;
            }
            
            currentOrderNumber = orderNumber;
            console.log('Order found!', orderDetails[orderNumber]);
            
            // Populate table dropdown with tables 1-50
            const tableSelect = document.getElementById('tableSelect');
            if (tableSelect) {
                tableSelect.innerHTML = '<option value="">Select your table...</option>';
                
                for (let i = 1; i <= 50; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    if (i <= 4) {
                        option.textContent = `VIP Table ${i}`;
                    } else {
                        option.textContent = `Table ${i}`;
                    }
                    tableSelect.appendChild(option);
                }
                console.log('Table dropdown populated');
            }
        });

        // Submit cancellation
        document.getElementById('submitCancellationBtn').addEventListener('click', function() {
            console.log('Submit button clicked');
            
            if (!currentOrderNumber) {
                alert('Please enter your order number first.');
                return;
            }
            
            const tableSelect = document.getElementById('tableSelect');
            if (!tableSelect) {
                alert('Table select not found.');
                return;
            }
            
            const selectedTable = tableSelect.value;
            console.log('Selected table:', selectedTable);
            
            if (!selectedTable) {
                alert('Please select your table.');
                return;
            }
            
            // Load data from localStorage
            let reservations = JSON.parse(localStorage.getItem('reservations')) || {};
            let orderDetails = JSON.parse(localStorage.getItem('orderDetails')) || {};
            
            const currentOrder = orderDetails[currentOrderNumber];
            if (!currentOrder) {
                alert('Order not found. Please try again.');
                return;
            }
            
            const orderDate = currentOrder.date;
            const tableNumber = selectedTable.toString();
            
            console.log('Order date:', orderDate, 'Table:', tableNumber);
            console.log('Reservations for date:', reservations[orderDate]);
            
            // Verify the order number matches the selected table
            if (reservations[orderDate] && reservations[orderDate][tableNumber]) {
                const lockedOrderNumber = reservations[orderDate][tableNumber];
                console.log('Locked order number:', lockedOrderNumber, 'Current:', currentOrderNumber);
                
                if (lockedOrderNumber.toString() !== currentOrderNumber.toString()) {
                    alert('This table is not associated with your order number. Please select the correct table.');
                    return;
                }
            } else {
                alert('This table is not reserved for this order. Please select the correct table.');
                return;
            }
            
            // Remove reservation
            if (reservations[orderDate] && reservations[orderDate][tableNumber]) {
                delete reservations[orderDate][tableNumber];
                if (Object.keys(reservations[orderDate]).length === 0) {
                    delete reservations[orderDate];
                }
                localStorage.setItem('reservations', JSON.stringify(reservations));
                console.log('Reservation removed');
            }
            
            // Remove order details
            delete orderDetails[currentOrderNumber];
            localStorage.setItem('orderDetails', JSON.stringify(orderDetails));
            console.log('Order details removed');
            
            // Update seating chart if on main page
            const dateInput = document.getElementById('date');
            if (dateInput && dateInput.value === orderDate) {
                if (typeof updateSeatingChartForDate === 'function') {
                    updateSeatingChartForDate(orderDate);
                }
                if (typeof updateTableDropdownForDate === 'function') {
                    updateTableDropdownForDate(orderDate);
                }
            }
            
            // Hide form and show thank you
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const thankYou = document.getElementById('thankYouMessage');
            
            if (step1) step1.style.display = 'none';
            if (step2) step2.style.display = 'none';
            if (thankYou) thankYou.style.display = 'block';
        });
    </script>
    <script src="script.js"></script>
</body>
</html>
